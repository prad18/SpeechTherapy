{% extends "base.html" %}

{% load static %}

{% block content %}

<!-- Existing content -->
<h2 class="wp-block-heading has-text-align-center"><br /></h2>
<div class="inline-menu-wrapper">
  <ul id="menu-phonics-1" class="inline-menu">
    <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7485">
      <a href="{% url 'letters' %}">Letters</a>
    </li>
    <li class=" menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-7278 current_page_item menu-item-7484">
      <a href="#">Learn</a>
    </li>
    <li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-7486">
      <a href="" aria-current="page">Track</a>
    </li>
  </ul>
</div>

<h2 class="wp-block-heading has-text-align-center" id="inline_menus">
  <br />Lets Learn!
</h2>

<div id="word-iteration">
  <h2>Current Word: <span id="current-word">{{ word }}</span></h2>
  <button id="record-btn">Record Pronunciation</button>
  <p id="score-display"></p>
</div>

<script>
  const audioPlayer = document.getElementById('audioPlayer');
  const menuItems = document.querySelectorAll('#menu-dictionary li');
  const csrfToken = "{{ csrf_token }}"; // Get the CSRF token from the Django template

  // Existing JavaScript code for audio playback

  // Word iteration and pronunciation checking
  const currentWordSpan = document.getElementById('current-word');
  const recordBtn = document.getElementById('record-btn');
  const scoreDisplay = document.getElementById('score-display');

  let currentWord = '{{ word }}';
  let recorder;

  function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        recorder = new MediaRecorder(stream);
        recorder.start();

        const audioChunks = [];
        recorder.addEventListener('dataavailable', event => {
          audioChunks.push(event.data);
        });

        recorder.addEventListener('stop', () => {
          const audioBlob = new Blob(audioChunks);
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', csrfToken); // Include the CSRF token
          formData.append('audio_file', audioBlob, 'audio.webm');
          formData.append('word', currentWord);

          fetch('{% url "check_pronunciation" %}', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            const score = data.score;
            scoreDisplay.textContent = `Pronunciation Score: ${score}%`;

            // Fetch the next word or redirect to the result view
            if (data.next_word) {
              currentWord = data.next_word;
              currentWordSpan.textContent = currentWord;
          } else {
              window.location.href = "{% url 'result'Â %}";
          }
          })
          .catch(error => {
            console.error('Error:', error);
          });
        });
      })
      .catch(error => {
        console.error('Error accessing microphone:', error);
      });
  }

  function stopRecording() {
    recorder.stop();
  }

  recordBtn.addEventListener('mousedown', startRecording);
  recordBtn.addEventListener('mouseup', stopRecording);
  recordBtn.addEventListener('mouseleave', stopRecording);
</script>

{% endblock %}